function calculateSummary() {
            const summary = {
                retirement: { marketValue: 0, gain: 0 },
                taxable: { marketValue: 0, gain: 0 },
                total: { marketValue: 0, gain: 0 }
            };

            state.quotes.forEach(q => {
                // Determine Account Type
                const type = (q.accountType || '').toLowerCase();
                // Expanded keywords for better detection
                const isRetirement = type.includes('retire') || 
                                     type.includes('ira') || 
                                     type.includes('401') || 
                                     type.includes('roth') || 
                                     type.includes('pension');
                
                const key = isRetirement ? 'retirement' : 'taxable';

                // 1. Calculate Market Value
                // Priority: Explicit marketValue > Calculated (Price * Qty) > 0
                let mv = q.marketValue;
                if (mv == null) {
                    mv = (q.price || 0) * (q.quantity || 0);
                }

                // 2. Calculate Total Gain
                // Priority: Explicit gain > Calculated (MV - Cost) > 0
                // This ensures the Summary matches the Stock Cards exactly
                let gain = q.gain;
                if (gain == null) {
                    // Fallback calculation only if gain is missing from data
                    // We only calculate if costBasis exists to avoid "Gain == MarketValue" bugs
                    if (q.costBasis != null) {
                        gain = mv - q.costBasis;
                    } else {
                        gain = 0;
                    }
                }

                summary[key].marketValue += mv;
                summary[key].gain += gain;
            });

            summary.total.marketValue = summary.retirement.marketValue + summary.taxable.marketValue;
            summary.total.gain = summary.retirement.gain + summary.taxable.gain;

            return summary;
        }
